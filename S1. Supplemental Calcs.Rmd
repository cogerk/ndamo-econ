---
title: "Supplemental Material 1. Model Calculations"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

### Model Assumptions
- The effect of pH and temperature were not considered in this analysis. Therefore:
  - 100% Nitrogen Removal is achieved in scenarios A, C, & D.
  - Maximum nitrogen removal (limited by anabolic production of nitrate by anammox) is achieved in scenario B.
  - 100% COD removal in all scenarios is achieved
- All COD sent to the anaerobic digestion process is converted to methane gas.
- 59% of sludge by weight is reduced in in the anaerobic digester in scenarios A, B, and C $x_digester$. [1]
- 62% of biogas by volume is is $CH_4$ ($x_{biogas_CH4}$) and 38% of biogas by volume is $CO_2$ ($x_{biogas_CO2}$). [1]
- Autotrophic consumption of $CO_2$ is negligible.
- Aerobic Methanogens are only active when methane concentration exceeds 5 mgCOD/L. At that point they remove 90% of methane present [8]



### Definitions & Input Parameters
*Z* represents a constituent (N for total nitrogen, COD for chemical oxygen demand, O2 for ozygen, etc.) and *Y* represents an organism (AOB for ammonium oxidizing bacteria, NOB for nitite oxidizing bacteria, etc.)

$Q$, Total daily volume into the wastewater treatment plant, million Liters/day 

$C_{Z_{in}}$, Concentration of *Z* in influent, mg/L

$t$, Temperature in ${}^\circ C$

#### Constants
$MW_Z$, Molecular weight of *Z*

$S_{Z_Y}$, Stoichiometric coefficient of *Z* in metabolism of organism *Y*

$Y_{x_Y}$, Sludge production of organism *Y* 

| Process                            | $S_{Z_{Y}}$           | $Y_{x_Y}$           |
| ---------------------------------- | --------------------- | ------------------- |
| Heterotrophic Denitrification [1]  | 5      gCOD/gN        | 0.30  gVSS/gCOD     |
| Heterotrophic Oxidation [1]        | 1      g$O_2$/gCOD    | 0.45  gVSS/gCOD     |
| Ammonium Oxidation [1]             | 1.5    mol$O_2$/molN  | 0.11  gCOD/gN       |
| Nitrite Oxidation [1]              | 0.5    mol$O_2$/molN  | 0.036  gCOD/gN      |
| Anammox [1]                        | N/A                   | 0.13  gCOD/gN       |
| N-damo  [2],[3]                    | 0.625  mol$CH_4$/molN | 0.22  gCOD/g$CH_4$  |
| Anaerobic Membrane [4]             | N/A                   | 0.036  gCOD/gCOD    |
| Aerobic Methane Oxidation [8]      | 16     g$O_2$/gCOD    | 0.19 gCOD/gCOD      |

$n=1.48$, gVSS/gCOD, conversion constant [5]

$s_CO2_HET$ = 0.08, kgCO2/kg COD, $CO_2$ respired by heterotrophic organisms on COD basis [6]

```{r, echo=FALSE}
### Constants
MW_O2 <<- 32
MW_CO2 <<- 44
MW_CH4 <<- 16
MW_N <<- 14
CH4_COD <<- 4
n_conv <<- 1.48          # gVSS/gCOD, conversion constant
H <- 0.0015 # Henry's Constant for methane
CO2eq_CH4 <<- 35 

# Stoichiometry
sCOD_HET <<- 5 # gCOD/gN, gCOD required per gN eaten by denitrifiers
sO2_AOB <<- 1.5 # Oxygen stoich coeff AOB 
sO2_NOB <<- 0.5 # Oxygen stoich coeff NOB
sCH4_NDAMO <<- 0.635 # stoich coeff of methane/nitrate for NDAMO    

# Temperature, Pressure, and pH impacts are largely not relevant to this model. 
T.mainstream <<- 25 # Degrees C, assumed
T.digester <<- 37 # Degrees C, assumed
pH <<- 7
P <<- 1 # atm, assumed

# Ideal Gas Law
R <- 0.082057338 # Universal Gas Constant, m3 atm/ kmol/K
vol.1molgas <- R * (T.digester + 273.15) / P

# Sludge production Factors
fx_AnMBR <<- 0.036   # gCOD/gCOD, gCOD of sludge produced in AnMBR per gCOD eaten
fx_DENIT <<- 0.32    # gCOD/gCOD, gCOD of sludge produced per gCOD eaten by denitrifiers
fx_HET <<- 0.21      # gCOD/gCOD, gCOD of sludge produced per gCOD eaten by COD oxidizing heterotrophs
fx_AOB <<- 0.11      # gCOD/gN, gCOD of sludge produced per gN eaten by AOB
fx_NOB <<- 0.036     # gCOD/gN, gCOD of sludge produced per gN eaten by NOB
fx_anamx <<- 0.13    # gCOD/gN, gCOD of sludge produced per gN eaten by anammox
fx_NDAMO <<- 0.22    # gCOD/gCH4,	gCOD of sludge produced per gCH4 eaten by NDAMO.

# Digester & CO2 Production
x_digester <<- 0.59 # Assumed digester sludge conversion
x_biogas_CH4 <<- 0.62 # Typical concentration of CH4 in biogas
sCO2_HET <<- 0.08 # kgCO2/kg COD
sCO2_NDAMO <<- MW_CO2/MW_CH4 # kgCO2/kg CH4
sCO2_BURN <<- MW_CO2/MW_CH4 # kgCO2/kg CH4
rho_CH4 <<- MW_CH4 / vol.1molgas #kg/m3
```

#### Calculated Parameters
$L_Z$, kg/day, Total load of *Z* into the treatment system

$L_{Z_{in}}$, kg/day, Total load of *Z* in the influent

$L_{N_{cent}}$, kgN/day, Nitrogen load per day from centrate

$O_{2_Y}$, kg$O_2$/day, Oxygen demand due to organism *Y*

$p_{x_Y}$, kgVSS/day, Sludge production of organism *Y*

$p_{x_{TOT}}$, kgVSS/day, Total sludge production

$COD_{req'd}$, kgCOD/day,  COD required for nitrogen removal

#### Model Outputs
$O_{2_{TOT}}$, kg$O_2$/day, Total oxygen demand of nitrogen removal system

$COD_{bal}$, kgCOD/day,  In Scenario A: COD addition required for or left over after nitrogen removal system

$L_{CH_{4}}$, kgCH$_4$/day, Dissolved methane in effluent

$CH_{4_{PROD}}$, m$^3$/day, Methane available for energy recovery

$p_{x_{out}}$, kgVSS/day, Total sludge from plant requiring sludge handling

### Sample Calculation
For this sample calcuation:

$Q = 40\;\;ML/d$

$t = 25\;^\circ C$

$C_{N_{in}} = 40\;\;mgN/L$

$C_{COD_{in}} = 100\;mgCOD/L$

```{r}
Q <- 40 
t <- 25
cNin <- 40 
cCODin <- 100
```

#### Step 1) Total Load Calculations
  First, the total nitrogen load into the system is calculated as the total nitrogen load in the influent plus to the total nitrogen load in the centrate for scenarios A, B & C, all of which have a side stream anaerobic digester.  Scenario D includes a mainstream digester, so there is no centrate and $L_N = L_{N_{in}}$.  However, for the first three scenarios:

$$L_N = L_{N_{in}}+L_{N_{cent}}$$
  Where:
$$L_{N_{in}}= C_{N_{in}}\times Q$$
  And where total nitrogen load in the centrate is assumed to be 40% of the total load in the influent, as is typical of wastewater centrate **[cite]**.
$$L_{N_{cent}}= C_{N_{in}}\times 0.4$$
  
  
  Total COD load into the system is also determined as follows:
$$L_{COD_{in}}= C_{COD_{in}}\times Q$$
```{r}
  (LNin <- Q * cNin) #kgN/d, Nitrogen load per day
  (LNcent <- .4 * LNin) #kgN/d, Nitrogen load from centrate, assumed 40% of total load
  (LN <- LNin + LNcent) #kgN/d, total nitrogen load
  (LCOD <- Q * cCODin) #kgCOD/d, COD load per day
```

#### Step 2a) Scenario A (MLE System) calculations 
** i. Nitrification **
  In traditional MLE, all nitrogen undergoes complete nitrification, so there is 100% conversion by AOB and NOB.
$$Y_{N_{AOB}}=Y_{N_{NOB}}=1$$
```{r}
  fN_AOB <- data.frame(A=1) # wt%, fraction of total N in converted by AOB, see appendix , assumed 100% in MLE system
  fN_NOB <- data.frame(A=fN_AOB$A)  # wt%, frac of totN converted by NOB, assumed 100% in MLE system
```
** ii. Denitrification **  
  COD required for denitrification is then calculated based on nitrogen into the system:
$$COD_{req'd}=L_{N}\times Y_{COD/HET}$$
	And compared to the total COD available to determine if external COD addition is required or if there is some COD left after treatment:
$$COD_{bal}= COD_{req'd}-L_{COD}$$

  Sludge production due to heterotrophs involved in denitrification is calculated as follows:
$$p_{x_{HET}} = COD_{req'd}\times n \times Y_{x_{HET}} $$
```{r}
(COD_reqd <- LN * fCOD_HET) # ammt of COD req'd.
(COD_bal <- data.frame(A=COD_reqd - LCOD)
px_HET <- data.frame(A=COD_reqd * n * fx_HET) #Slude produced
```

#### Step 2b) Scenario B (CANON Anammox) calculations 
** i. COD Removal **  
  Anammox are an autotrophic organism that does not require organic carbon.  Therefore, a high-rate BOD removal system is required. 100% conversion is assumed in this scenario.
$$Y_{COD_{HET}}=1$$
As per the definition of chemical oxygen demand, the O2 demand from the highrate system is calculated as:
$$Y_{COD_{HET}} \times L_{COD}$$

This heterotrophic process does not require any COD addition

```{r}
fCOD_HET <- data.frame(A=NA, B=1) # Assume 100% conversion of COD
(O2_HET <- data.frame(A=0, B= fCOD_HET * LCOD)) # FIX THIS LINE
(COD_bal$B <- (1-fCOD_HET$B) * LCOD)
```

** ii. CANON Anammox system **
It is assumed that partial nitrifcation occurs at a ratio that is ideal for anammox removal, that is for the anammox reaction:
$$1 NH_4^+ + 1.3NO_2^- \rightarrow 1N_2 + 0.3 NO_3^- [7]$$
$$Y_{N_{AOB}} = \frac{s_{{NO_2^-}_{amx}}}{s_{{NO_2^-}_{amx}}+s_{{NH_4^+}_{amx}}} =\frac{1.3}{1.3+1}=0.57$$
$$Y_{N_{NOB}} = 0$$
Assume, with a stoichiometric feed into the CANON reactor, assume anammox will convert 100% of nitrogen.
$$Y_{NH_{4_{AMX}}} = 1$$

```{r}
  fN_AOB <- 0.57, # wt%, fraction of total N in converted by AOB, 
  fN_NOB <- 0,  # wt%, frac of totN converted by NOB, assumed 100% in anammox system # Make temp dependent?
  fN_anamx <- (1 - fN_AOB) * 2 * 1.02

```

#### Step 2c) Scenario C (Anammox/NDAMO) Calculations
** i. COD Removal **  
COD Removal in scenario C is identical to COD removal in scenario B.
** i. Nitrifcation **
50% of flow was calculated to be the appropriate diversion to ensure 100% N conversion as follows:
$$Anammox\space Reaction: 1 NH_4^+ + 1.3 NO_2^- \rightarrow 1N_2 + 0.3 NO_3^- [7] $$
$$NDAMO\space Reaction: 1 NO_2^- \rightarrow + 1 NO_3^- [2]$$ 

Multiply the NDAMO reaction by 1.3 (130% of the influent will be converted by n-damo, more than 100% is OK because nitrate produced by anammox will be converted back to nitrite by n-damo for another round of anammox) and sum these two reactions to find the required fraction of $NO_3^-$ to be fed into the anammox reactor:
$$1 NH_4^+ + 1.3 NO_2^- \rightarrow 1 N_2 + 0.3 NO_3^- [7] $$
$$+$$
$$1.3 NO_3^- \rightarrow + 1.3 NO_2^-$$ 
$$Anammox/NDAMO \space Overall: 1 NH_4^+ + 1 NO_3^- \rightarrow 1 N_2 $$
Therefore, the conversion by AOB & NOB is:
$$Y_{N_{AOB}}=Y_{N_{NOB}}=\frac{s_{{NO_2^-}_{amx/ndamo}}}{s_{{NO_2^-}_{amx/ndamo}}+s_{{NH_4^+}_{amx/ndamo}}}=\frac{1}{1+1}=0.5$$
Total conversion by n-damo is 130% and total conversion by anammox is 100% due to the multiplying factors used in finding the overall reaction.
$$Y_{N_{ndamo}}=1.3$$
$$Y_{N_{amx}}=1$$





Unlike the CANON system, The nitrification system is assumed to have 100% nitratation by NOB.

$$Y_{N_{AOB}} = Y_{N_{NOB}} = 1 - 0.485$$

```{r}
  fN_AOB = 1 - 0.485, # wt%, fraction of total N in converted by AOB, see appendix
  fN_NOB = fN_AOB
```




#### Step 3) Non-scenario dependent calculations
Oxygen demand of a given nitrifying aerobic organism is calculated as:
$$O_{2_Y}=\frac{Y_{N_Y}\times L_N}{MW_N}\times S_{O_{2_Y}}×MW_{O_2}$$
Sludge production due to a given organism (*Y*) consuming a given contaminent (*Z*) is calculated as: 
$$p_{x_Y}=Y_{Z_Y}×Y_{x_Y} \times n\times L_Z$$
* With the exception of $p_{x_{HET}}$ in scenario A, calculated as per above

```{r}
  (O2_A <- data.frame(AOB=(fN_AOB_A * LN_A)/MW_N * MW_O2 * sO2_AOB)) # kg/D O2 req'd by AOB
  (O2_B$NOB <- (fN_NOB_A * LN_A) / MW_N * MW_O2 * sO2_NOB) # kg/D O2 req'd by NOB
  (px_A <- data.frame(AOB=fN_AOB_A * fx_AOB * n * LN_A)) #kg/d, sludge produced from AOB
  (px_A$NOB <- fN_NOB_A * fx_NOB * n * LN_A) #kg/d, sludge produced from NOB
  
  O2_B <- data.frame(AOB = (fN_AOB * LN) / MW_N * MW_O2 * sO2_AOB), # kg/D O2 req'd by AOB
  O2_B$NOB <- (fN_NOB * LN) / MW_N * MW_O2 * sO2_NOB, # kg/D O2 req'd by NOB
  px_B <- data.frame(HET = fCOD_HET * LCOD * fx_HET *n), # Oxygen Demand/Sludge Handling
  px_B$AOB <- fN_AOB * fx_AOB * n * LN, #kg/d, sludge produced from AOB
  px_B$NOB <- fN_NOB * fx_NOB * n * LN, #kg/d, sludge produced from NOB
  px_B$AMX <- fN_anamx*fx_anamx*LN #kg/d, sludge produced from anammox
```
Total sludge production is then just the sum of all these terms for all organisms:
$$p_{x_{TOT}} = \Sigma p_{x_y}$$

```{r}
  (px_TOT = data.frame(A = sum(px_A), B = sum(px_B))) #kg/d, total sludge produced
```

#### Step 4a,b & c) Anaerobic Digester Calculations
  In scenarios A, B, and C, there is an anaerobic sludge digester reducing the total amount of sludge requiring handling.  In scenario D, this task is effectively done by the AnMBR.
  A typical anaerobic digester sludge reduction factor $Y_{x_{digester}} = $ is used to calculate actual sludge out of the system requiring handling:
$$p_{x_{out}}=p_{x_{TOT}}\times(1-Y_{x_{digester}})$$
	The COD of the digested sludge is converted to methane:
$$CH_{4_{prod}} =  \frac{p_{x_{TOT}}-p_{x_{out}}}{n}\times Y_{CH_4/COD}$$
```{r}
  (px_out <- px_TOT * (1 - fx_digester))
  (CH4prod <- (px_TOT - px_out)/n * Y_CH4_COD) #m3 CH4 produced/day calculated as a mass balance
  (LCH4 <- data.frame(A=0, B=0))
```

#### Step 4d)
There is no sludge reduction step in this scenario, so total sludge produced is the total sludge requiring handling.
$$p_{x_{out}}=p_{x_{TOT}}$$

#### Step 5) Model Outputs

One set of the following values is returned per scenario.  Total oxygen demand is just the sum of all the oxygen required by aerobic organism to perform the assumed reaction:
$$O_{2_{TOT}} = \Sigma O_{2_Y}$$
```{r}
O2_TOT <- data.frame(A = sum(O2_A), B = sum(O2_B)))
```

$p_{x_{out}}$, or sludge requiring handling, is calcuated in step 4 above for all four scenarios.

$COD_{added}$, the external addition of COD required is also calcuated above in each particular scenario.  Note that the nitrogen removal in scenario B does not require COD, so this value will always be 0 in scenario B.

$L_CH4$, The dissolved methane consumed in scenario D.  This will be always be 0 for scenarios B, C, and D.

${CH_{4_{PROD}}}$ The m$^3$ of CH$_4$ produced for energy recovery is in step 4 for each particular scenario above as well.

### References
[1]	G. Tchobanoglous, F. L. Burton, and H. D. Stensel, Wastewater Engineering: Treatment and Resource Recovery, 4th ed. New York, New York: McGraw Hill, 2014.
[2]	K. F. Ettwig, T. van Alen, K. T. van de Pas-Schoonen, M. S. M. Jetten, and M. Strous, “Enrichment and molecular detection of denitrifying methanotrophic bacteria of the NC10 phylum.,” Appl. Environ. Microbiol., vol. 75, no. 11, pp. 3656–62, Jul. 2009.
[3]	M.-K. H. Winkler, K. F. Ettwig, T. P. W. Vannecke, K. Stultiens, A. Bogdan, B. Kartal, and E. I. P. Volcke, “Modelling simultaneous anaerobic methane and ammonium removal in a granular sludge reactor.,” Water Res., vol. 73, pp. 323–31, Apr. 2015.
[4]	J. Gouveia, F. Plaza, G. Garralon, F. Fdz-Polanco, and M. Peña, “Long-term operation of a pilot scale anaerobic membrane bioreactor (AnMBR) for the treatment of municipal wastewater under psychrophilic conditions,” Bioresour. Technol., vol. 185, pp. 225–233, Jun. 2015.
[5]	G. v R. Marais and G. A. Ekama, “The activated sludge process – Part 1: Steady state behaviour,” WATER SA, vol. 2, no. 4, 1976.
[6]	J. L. Campos, D. Valenzuela-Heredia, A. Pedrouso, A. Val del Río, M. Belmonte, and A. Mosquera-Corral, “Greenhouse Gases Emissions from Wastewater Treatment Plants: Minimization, Treatment, and Prevention,” J. Chem., vol. 2016, pp. 1–12, Apr. 2016.
[7] Van der Star....
[8] Daelman methane paper
